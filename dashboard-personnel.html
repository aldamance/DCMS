<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DENR-CENRO Diffun â€” Digital Client Management Dashboard</title>
  <link rel="icon" href="assets/denrlogo.png" type="image/svg+xml" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --green-900:#08331a;
      --green-700:#0b6137;
      --muted:#6b7280;
      --bg:#f7f9fb;
      --card:#ffffff;
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f7fbf7 0%, #f7f9fb 100%);color:#0f172a}

    .app{display:flex;min-height:100vh}
    .sidebar{
      width:280px;background:var(--green-900);color:white;padding:20px 16px;display:flex;flex-direction:column;gap:20px;transition:width .25s ease;
      box-shadow:0 6px 18px rgba(3,10,7,0.15)
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h1{font-size:15px;margin:0}
    .brand p{margin:0;font-size:11px;opacity:.92}

    nav{display:flex;flex-direction:column;gap:8px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer;transition:background .18s, transform .08s;user-select:none}
    .nav-item:hover{background:rgba(255,255,255,0.06);transform:translateX(4px)}
    .nav-item.active{background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03))}
    .nav-item svg{opacity:.95}

    .content{flex:1;padding:28px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .title{font-size:18px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(16,24,40,0.06);}

    /* MODERN DIGITAL CLOCK STYLES */
    #realtime-datetime {
      text-align: center;
      /* Use a monospace-like font for the digital look */
      font-family: 'Inter', 'DSEG7 Classic', monospace; 
      font-size: 24px; /* Slightly larger for visibility */
      font-weight: 700;
      color: var(--green-900); /* Use a dark color for contrast */
      margin-bottom: 20px; /* More space */
      padding: 10px 15px;
      background-color: #e2e8f0; /* Light, soft background */
      border-radius: 8px;
      letter-spacing: 1px; /* Spacing for the digital look */
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      /* New properties to structure the date and time */
      display: flex;
      flex-direction: column;
    }

    /* Style for the time part */
    .time-display {
        font-size: 38px; /* Prominent time */
        color: var(--green-700); 
        font-weight: 900;
    }

    /* Style for the date and day part */
    .date-display {
        font-size: 14px;
        font-weight: 600;
        color: var(--muted);
        margin-top: 4px;
    }
    /* END MODERN DIGITAL CLOCK STYLES */
    
    .actions{display:flex;gap:10px;justify-content:center;margin-top:8px}
    button{
        padding:10px 14px;
        border-radius:10px;
        border:0;
        background:var(--green-700);
        color:white;
        font-weight:600;
        cursor:pointer;
        transition:transform .12s, box-shadow .12s, background-color .12s;
    }
    button:hover {
        background-color: #0c7340;
        box-shadow: 0 4px 12px rgba(11, 97, 55, 0.2);
    }
    button.secondary{
        background:transparent;
        color:var(--green-700);
        border:1px solid rgba(11,97,55,0.12);
    }
    button.secondary:hover {
        background: rgba(11,97,55,0.05);
        box-shadow: none;
    }
    button:active{transform:translateY(1px)}

    /* NEW: Style for the loading state of the sync button */
    button.loading {
        pointer-events: none; /* Crucial for preventing double clicks */
        opacity: 0.7;
        cursor: wait;
    }

    /* --- Table Styles for Modernization --- */
    #clientListContainer { overflow-x: auto; }
    table{width:100%;border-collapse:collapse;margin-top:12px;min-width: 700px;} 
    thead th{text-align:left;padding:12px 8px;color:var(--muted);font-size:13px;border-bottom:1px solid #eef5f7}
    tbody td{padding:12px 8px;border-bottom:1px solid #fbfcfd; font-size: 14px;}
    
    /* New Detail Row Style */
    .detail-row td {
        background: #fcfdfe;
        padding: 0;
        border-bottom: 1px solid #eef5f7;
    }
    .detail-content {
        padding: 12px 18px;
        font-size: 13px;
        line-height: 1.6;
        color: #333;
    }
    .detail-content strong { color: var(--green-700); }
    .detail-row.hidden { display: none; }
    
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}

    /* Search Bar Style */
    #search-input {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
      text-transform: none; /* Do not force uppercase for searching */
    }

    /* Fade-in for page content */
    .fade-in{animation:fadeIn .28s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    @media (max-width:900px){
      .sidebar{width:68px;padding:16px}
      .brand h1,.brand p{display:none}
      table{min-width: unset;} /* Allow table to shrink on mobile */
    }

    /* Splash Screen */
    #splash-intro {
      position:fixed;top:0;left:0;width:100%;height:100%;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      background:#08331a;color:white;z-index:9999;transition:opacity 0.5s ease-out;
    }

    .developed-by {
      position: fixed;bottom: 1rem;right: 1rem;
      color: #6b7280;font-size: 11px;opacity: 0.9;text-align:right;
    }

    /* Style for Pagination Controls */
    .pagination-controls {
        display:flex; 
        justify-content:center; 
        gap:10px; 
        margin-top:12px;
    }
    .pagination-controls span {
        display:flex; 
        align-items:center; 
        color:var(--muted); 
        font-size:14px;
    }
    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        background: rgba(11,97,55,0.02); /* Very light background for disabled secondary */
    }
  </style>
</head>
<body>
  <div id="splash-intro">
    <img src="assets/logo1.png" alt="DENR-CENRO Diffun Logo" style="width: 200px; height:auto; border-radius:12px;">
    <h1>DENR-CENRO Diffun</h1>
    <h3>Digital Client Management Dashboard</h3>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="assets/denrlogo.png" alt="DENR-CENRO Diffun" class="logo">
        <div>
          <h1>DENR-CENRO Diffun</h1>
          <p style="font-weight:600">Client Management Dashboard</p>
        </div>
      </div>

      <nav>
        <div class="nav-item active" data-view="client-list" id="nav-client-list">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div>Logged Clients List</div>
        </div>
      </nav>

      <div style="margin-top:auto;font-size:12px;opacity:.95" id="statusContainer">
        <div class="muted">Status:</div>
        <div style="margin-top:6px;font-weight:700">Checking...</div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div>
          <div class="title">Digital Client Management Dashboard</div>
          <div class="subtitle">DENR-CENRO Diffun</div>
        </div>
        <div class="row">
          <div id="realtime-datetime" style="margin-right: 20px; margin-bottom: 0;"></div>
          <button id="syncBtn" class="secondary">Sync List</button>
        </div>
      </div>

      <section id="view-client-list" class="card fade-in">
        <h3>Logged Clients</h3>
        <input type="text" id="search-input" placeholder="Search by Name, Purpose, or Section..." />
        <div id="clientListContainer">Loading...</div>
      </section>
    </main>
  </div>

  <div class="developed-by">
    Developed by <br><strong>ALDRIN N. DAMANCE, LPT <br>IT TECHNICAL SUPPORT STAFF</strong>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Replace this with your deployed Web App URL
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby4gdcxwVmcfUERW0FDEqiFNu0mcGUXiMONI8uNRhdh44MH5bj8f7UIyUh-zl_vqqSvWw/exec';
    
    let allClients = [];
    let initialLoad = true; 

    // State for filtering
    let currentFilter = '';

    // Pagination related variables
    let currentPage = 1;
    const rowsPerPage = 10;

    const navItems = document.querySelectorAll('.nav-item');
    const views = {
        'client-list': document.getElementById('view-client-list')
    };
    const syncBtn = document.getElementById('syncBtn');
    const clientListContainer = document.getElementById('clientListContainer');
    const statusContainer = document.getElementById('statusContainer');
    const realtimeDatetime = document.getElementById('realtime-datetime');
    const splashIntro = document.getElementById('splash-intro');
    const searchInput = document.getElementById('search-input'); 

    // Date formatting options (for re-use)
    const dateOptions = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };

    // --- Audio Alert Function to say official's name twice (FIXED) ---
    function speakNewClientAlert(section, personnel) {
        if (!('speechSynthesis' in window)) {
            console.warn("Speech Synthesis not supported for client alerts.");
            return;
        }

        // ðŸ’¡ FIX: Cancel any ongoing speech (like the hourly time announcement) to prioritize this alert
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }

        const alertMessage = `Attention! A new client has logged in for the ${section} section. Concerned Official: ${personnel}! Concerned Official: ${personnel}! Please attend to the client immediately.`;
        
        const utterance = new SpeechSynthesisUtterance(alertMessage);
        utterance.volume = 1; 
        utterance.rate = 1;   
        
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('en'));

        if (preferredVoice) {
             utterance.voice = preferredVoice;
        } else if (voices.length > 0) {
             utterance.voice = voices[0];
        }

        window.speechSynthesis.speak(utterance);
    }
    // ------------------------------------
    
    // --- SweetAlert Notification Function ---
    function showNewClientSwal(client) {
        const clientName = `${client.firstName || ''} ${client.lastName || ''}`.trim();

        Swal.fire({
            toast: true,
            position: 'top-end', // Displays in the top right corner
            icon: 'info',
            title: 'New Client Logged In',
            html: `
                <div style="text-align: left;">
                    <strong>Client:</strong> ${clientName} <br>
                    <strong>Section:</strong> ${client.section || 'N/A'} <br>
                    <strong>Official:</strong> ${client.personnel || 'N/A'}
                </div>
            `,
            showConfirmButton: false,
            timer: 10000, // Disappears after 10 seconds
            timerProgressBar: true
        });
    }
    // ---------------------------------------------

    function switchView(view) {
        navItems.forEach(x => x.classList.remove('active'));
        document.getElementById(`nav-${view}`).classList.add('active');
        for (const k in views) views[k].style.display = (k === view) ? 'block' : 'none';
        if (view === 'client-list') {
             if (allClients.length === 0) loadClientList(false);
             else applyFilterAndRender(false); 
        }
    }
    
    // --- Search Filter Logic ---
    function applyFilterAndRender(resetPage = true) {
        if (resetPage) {
            currentPage = 1; 
        }
        const filterText = currentFilter.toLowerCase();
        
        const filteredClients = allClients.filter(client => {
            if (!filterText) return true; 
            
            const searchPool = [
                client.firstName, 
                client.lastName, 
                client.purpose, 
                client.section, 
                client.personnel,
                client.address
            ].join(' ').toLowerCase();

            return searchPool.includes(filterText);
        });
        
        renderClients(filteredClients);
    }
    
    // Event listener for search input
    searchInput.addEventListener('input', (e) => {
        currentFilter = e.target.value;
        applyFilterAndRender(); 
    });


    // Client List and Sync 
    async function loadClientList(isAutomatic = false) { 
        if (!isAutomatic) {
             clientListContainer.innerHTML = "<div style='text-align:center;'>Loading Client Data...</div>";
        }
       
        if (!isAutomatic) {
            syncBtn.textContent = 'Syncing...';
            syncBtn.classList.add('loading');
        }
        
        let success = true;
        let fetchedClients = [];

        try {
            const res = await fetch(GAS_URL + '?action=list_clients');
            fetchedClients = await res.json();
        } catch(error) {
            fetchedClients = JSON.parse(localStorage.getItem('clients') || '[]');
            console.error("Failed to fetch from server, falling back to local storage.", error);
            if (!isAutomatic) { 
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Load Warning',
                    text: 'Could not connect to the server. Displaying cached (local) data.',
                    confirmButtonColor: '#f59e0b'
                });
            }
            success = false;
        } finally {
             // Stop loading state
            if (!isAutomatic) {
                syncBtn.textContent = 'Sync List';
                syncBtn.classList.remove('loading');
            } else {
                 if(success) {
                     const originalText = 'Sync List';
                     syncBtn.textContent = 'Synced!';
                     setTimeout(() => syncBtn.textContent = originalText, 1000);
                 }
            }
        }
        
        // --- NEW CLIENT DETECTION LOGIC ---
        const existingClientIDs = new Set(allClients.map(c => c.timestamp)); 
        
        fetchedClients.sort((a, b) => {
            const dateA = new Date(a.timestamp);
            const dateB = new Date(b.timestamp);
            return dateB - dateA; 
        });

        const newestClient = fetchedClients[0];

        // Only alert if it's NOT the initial load AND the newest client's timestamp is new
        if (newestClient && !initialLoad && !existingClientIDs.has(newestClient.timestamp)) {
            // 1. Audible Alert (now fixed to prioritize itself)
            speakNewClientAlert(newestClient.section, newestClient.personnel);

            // 2. SweetAlert Notification
            showNewClientSwal(newestClient);
        }
        
        // Update the main list and toggle the initial load flag
        allClients = fetchedClients;
        initialLoad = false;
        // ------------------------------------

        applyFilterAndRender(false); // Do not reset page on sync to maintain user's current view
    }

    // Function to render the pagination controls
    function renderPagination(rows, container) {
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        if (totalPages <= 1) return; 

        const paginationDiv = document.createElement('div');
        paginationDiv.classList.add('pagination-controls');

        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Previous';
        prevBtn.classList.add('secondary');
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                applyFilterAndRender(false); 
            }
        };
        
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Next';
        nextBtn.classList.add('secondary');
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                applyFilterAndRender(false); 
            }
        };

        paginationDiv.appendChild(prevBtn);
        paginationDiv.appendChild(pageInfo);
        paginationDiv.appendChild(nextBtn);
        container.appendChild(paginationDiv);
    }

    // Toggle Detail Row
    function toggleDetails(button) {
        const tr = button.closest('tr');
        const nextRow = tr.nextElementSibling; 
        
        if (nextRow && nextRow.classList.contains('detail-row')) {
            const isHidden = nextRow.style.display === 'none' || nextRow.style.display === '';
            nextRow.style.display = isHidden ? 'table-row' : 'none';
            button.textContent = isHidden ? 'Hide Details' : 'View Details';
        }
    }


    // Client List Renderer
    function renderClients(rows) {
        if (!rows.length) {
            clientListContainer.innerHTML = currentFilter ? 'No clients found matching your search.' : 'No records yet.';
            return;
        }
        
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const rowsToDisplay = rows.slice(startIndex, endIndex);


        const table = document.createElement('table');
        table.innerHTML = '<thead><tr><th>Name</th><th>Concerned Section/Office</th><th>Concerned Official</th><th>Purpose (Preview)</th><th>Time Logged</th><th>Action</th></tr></thead>';
        const tbody = document.createElement('tbody');
        
        rowsToDisplay.forEach(r => {
            
            // --- 1. TIMESTAMP FORMATTING FIX ---
            const rawTimestamp = r.timestamp || '';
            let formattedTimestamp = rawTimestamp;

            if (rawTimestamp && rawTimestamp.includes('T') && rawTimestamp.includes('Z')) {
                try {
                    const dateObj = new Date(rawTimestamp);
                    formattedTimestamp = dateObj.toLocaleDateString('en-US', dateOptions);
                } catch (e) {
                    // Fallback to raw timestamp
                }
            }
            // ------------------------------------

            // --- 2. PURPOSE TRUNCATION (for main view) ---
            const fullPurpose = r.purpose || 'N/A';
            let displayedPurpose = fullPurpose;
            const words = fullPurpose.split(/\s+/); 
            if (words.length > 5) { 
                displayedPurpose = words.slice(0, 5).join(' ') + '...';
            }
            const purposeCell = `<td title="${fullPurpose}">${displayedPurpose}</td>`;
            // ------------------------------------
            
            // MAIN ROW
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.lastName || ''}, ${r.firstName || ''}</td>
              <td>${r.section || ''}</td>
              <td>${r.personnel || ''}</td>
              ${purposeCell}
              <td class="muted">${formattedTimestamp || ''}</td>
              <td><button class="secondary" onclick="toggleDetails(this)">View Details</button></td>
            `;
            tbody.appendChild(tr);

            // DETAIL ROW (Initially hidden)
            const detailTr = document.createElement('tr');
            detailTr.classList.add('detail-row');
            detailTr.style.display = 'none'; 
            detailTr.innerHTML = `
                <td colspan="6">
                    <div class="detail-content">
                        <strong>Full Address:</strong> ${r.address || 'N/A'} <br>
                        <strong>Full Purpose:</strong> ${r.purpose || 'N/A'} <br>
                        <strong>Age:</strong> ${r.age || 'N/A'} &bull; 
                        <strong>Mobile:</strong> ${r.mobile || 'N/A'}
                    </div>
                </td>
            `;
            tbody.appendChild(detailTr);
        });
        
        table.appendChild(tbody);
        clientListContainer.innerHTML = ''; 
        clientListContainer.appendChild(table);
        
        renderPagination(rows, clientListContainer);
    }
    
    // Expose toggleDetails globally for the onclick attribute
    window.toggleDetails = toggleDetails;
    
    syncBtn.addEventListener('click', () => {
        currentFilter = ''; 
        searchInput.value = '';
        loadClientList(false); // Manual sync
    }); 
    
    // Initial data load on startup
    loadClientList(false); 

    // --- Automatic Refresh Logic (10 seconds for faster "live" feel) ---
    // 10000 milliseconds = 10 seconds
    setInterval(() => {
        if (currentFilter === '') {
            loadClientList(true); // Automatic sync
        }
    }, 10000);
    // --------------------------------------------------------

    // Status Check 
    async function checkConnection() {
        try {
            const res = await fetch(GAS_URL);
            if (res.ok) {
                statusContainer.innerHTML = '<div class="muted">Status:</div><div style="color:#22c55e">Connected</div>';
            } else {
                throw new Error('Server not reachable');
            }
        } catch {
            statusContainer.innerHTML = '<div class="muted">Status:</div><div style="color:#ef4444">Not Connected</div>';
        }
    }
    checkConnection();


    // Real-time Date and Time 
    function updateDateTime() {
        const now = new Date();

        const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
        const timeString = now.toLocaleTimeString('en-US', timeOptions);
        
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = now.toLocaleDateString('en-US', dateOptions);

        realtimeDatetime.innerHTML = `
            <span class="time-display">${timeString}</span>
            <span class="date-display">${dateString}</span>
        `;
    }

    setInterval(updateDateTime, 1000);
    updateDateTime();
    
    // --- START: HOURLY TIME ANNOUNCEMENT LOGIC ---

    let lastAnnouncedHour = null; 

    function speakTime(hour) {
        const timeString = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const textToSpeak = `Attention, the current time is ${timeString}.`;
        
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.volume = 1; 
            utterance.rate = 1;   
            
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('en'));

            if (preferredVoice) {
                 utterance.voice = preferredVoice;
            } else if (voices.length > 0) {
                 utterance.voice = voices[0];
            }

            window.speechSynthesis.speak(utterance);
        } else {
            console.warn("Speech Synthesis not supported in this browser.");
        }
    }

    function setupHourlyAnnouncements() {
        const now = new Date();
        const currentHour = now.getHours();
        
        if (currentHour !== lastAnnouncedHour) {
            if (now.getMinutes() === 0 && now.getSeconds() < 60) {
                // This check prevents the hourly announcement from interrupting a client alert.
                if (!window.speechSynthesis.speaking) {
                     speakTime(currentHour);
                }
                lastAnnouncedHour = currentHour; 
            }
        }

        setTimeout(setupHourlyAnnouncements, 1000); 
    }
    
    setupHourlyAnnouncements();

    // --- END: HOURLY TIME ANNOUNCEMENT LOGIC ---


    // Splash Screen (Retained)
    setTimeout(() => {
        splashIntro.style.opacity = '0';
        setTimeout(() => splashIntro.remove(), 500);
    }, 1500);
});
</script>
</body>
</html>